<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend Company Form View -->
    <record id="view_partner_form_btp_company" model="ir.ui.view">
        <field name="name">res.partner.form.btp.company</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <data>
            <!-- Add BTP Company fields after the main address block -->
            <xpath expr="//sheet/group[1]" position="after">
                <field name="btp_duplicate_warning" invisible="1"/>
                <group name="btp_company_info" string="BTP Company Information" col="4" modifiers="{'invisible': [('company_type', '!=', 'company')]}">
                    <field name="siren" colspan="2"/>
                    <field name="btp_group_id" colspan="2"/>
                    <field name="siret" colspan="2"/>
                    <field name="btp_subsidiary_id" domain="[('group_id', '=', btp_group_id)]" colspan="2"/>
                    <field name="naf_code" colspan="2"/>
                    <field name="btp_agency_id" domain="[('subsidiary_id', '=', btp_subsidiary_id)]" colspan="2"/>
                    <field name="legal_form" colspan="2"/>
                    <field name="btp_assigned_salesperson_id" colspan="2"/>
                    <field name="capital" widget="monetary" colspan="2"/>
                    <field name="btp_is_prospect" widget="boolean_toggle" colspan="2"/>
                    <field name="btp_is_client" widget="boolean_toggle" readonly="1" colspan="2"/>
                </group>
                <group name="btp_api_info" string="API Information" modifiers="{'invisible': [('company_type', '!=', 'company'), ('btp_api_enriched', '=', False)]}">
                    <field name="btp_api_enriched" widget="boolean_toggle"/>
                    <field name="btp_api_source"/>
                </group>
                <div class="alert alert-warning" role="alert"
                     invisible="not id or not btp_duplicate_warning or not btp_duplicate_message">
                    <strong>Duplicate Warning:</strong>
                    <field name="btp_duplicate_message" nolabel="1"/>
                </div>
            </xpath>

            <!-- Add API enrichment button -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_enrich_from_api" type="object" 
                        string="Enrich from API" 
                        class="oe_stat_button"
                        modifiers="{'invisible': [('is_company', '=', False), ('siren', '=', False)]}"
                        groups="btp_prospecting.group_btp_salesperson,btp_prospecting.group_btp_manager"/>
            </xpath>

            <!-- Add Multi-company sharing tab -->
            <notebook position="inside">
                <page string="BTP Multi-Company" name="btp_multi_company" modifiers="{'invisible': [('is_company', '=', False)]}">
                    <group>
                        <field name="btp_shared_company_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                    </group>
                </page>
                <page string="Addresses" name="btp_addresses" modifiers="{'invisible': [('is_company', '=', False)]}">
                    <field name="btp_address_ids" nolabel="1">
                        <list editable="bottom">
                            <field name="address_type"/>
                            <field name="name"/>
                            <field name="street"/>
                            <field name="city"/>
                            <field name="zip"/>
                            <field name="country_id"/>
                        </list>
                        <form>
                            <sheet>
                                <group>
                                    <group>
                                        <field name="address_type"/>
                                        <field name="name"/>
                                        <field name="phone"/>
                                        <field name="email"/>
                                    </group>
                                    <group>
                                        <field name="street"/>
                                        <field name="street2"/>
                                        <field name="city"/>
                                        <field name="zip"/>
                                        <field name="state_id"/>
                                        <field name="country_id"/>
                                    </group>
                                </group>
                            </sheet>
                        </form>
                    </field>
                </page>
                <page string="Sites" name="btp_sites" modifiers="{'invisible': [('is_company', '=', False)]}">
                    <field name="btp_site_ids" nolabel="1">
                        <list>
                            <field name="name"/>
                            <field name="agency_id"/>
                            <field name="city"/>
                            <field name="country_id"/>
                            <field name="active" widget="boolean_toggle"/>
                        </list>
                    </field>
                </page>
                <page string="Commercial Conditions" name="btp_commercial_conditions" modifiers="{'invisible': [('is_company', '=', False)]}">
                    <field name="btp_commercial_condition_ids" nolabel="1">
                        <list editable="bottom">
                            <field name="company_id"/>
                            <field name="pricelist_id"/>
                            <field name="payment_term_id"/>
                            <field name="incoterm_id"/>
                        </list>
                        <form>
                            <sheet>
                                <group>
                                    <field name="company_id"/>
                                    <field name="pricelist_id"/>
                                    <field name="payment_term_id"/>
                                    <field name="incoterm_id"/>
                                    <field name="notes"/>
                                </group>
                            </sheet>
                        </form>
                    </field>
                </page>
                <page string="Reattributions" name="btp_reattribution"
                      modifiers="{'invisible': [('is_company', '=', False)]}"
                      groups="btp_prospecting.group_btp_manager,btp_prospecting.group_btp_admin">
                    <field name="btp_reattribution_ids" nolabel="1">
                        <list>
                            <field name="old_user_id"/>
                            <field name="new_user_id"/>
                            <field name="changed_by_id"/>
                            <field name="change_date"/>
                        </list>
                    </field>
                </page>
            </notebook>

            <!-- Duplicate warning moved with company info group -->
            </data>
        </field>
    </record>

    <!-- Extend Contact Form View -->
    <record id="view_partner_form_btp_contact" model="ir.ui.view">
        <field name="name">res.partner.form.btp.contact</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <data>
            <!-- Add Mobile field for contacts -->
            <xpath expr="//field[@name='phone']" position="after">
                <field name="mobile" modifiers="{'invisible': [('company_type', '=', 'company')]}"/>
            </xpath>

            <!-- Add BTP Contact fields -->
            <field name="function" position="after">
                <field name="btp_duplicate_warning" invisible="1"/>
            </field>

            <xpath expr="//sheet/group[group/field[@name='parent_id']]" position="after">
                <separator string="BTP Contact Information" modifiers="{'invisible': [('company_type', '=', 'company')]}"/>
                <group name="btp_contact_info" col="2" modifiers="{'invisible': [('company_type', '=', 'company')]}">
                    <field name="btp_contact_assigned_salesperson_id"/>
                    <field name="btp_current_company_id" widget="many2one" readonly="1"
                           options="{'no_open': True, 'no_create': True, 'no_quick_create': True}"
                           placeholder="Auto from career history"/>
                </group>
                <div class="alert alert-warning" role="alert"
                     invisible="not id or not btp_duplicate_warning or not btp_duplicate_message">
                    <strong>Duplicate Warning:</strong>
                    <field name="btp_duplicate_message" nolabel="1"/>
                </div>
                <group name="btp_duplicate_actions"
                       modifiers="{'invisible': ['|', ('company_type', '=', 'company'), '|', ('btp_duplicate_warning', '=', False), '|', ('btp_duplicate_message', '=', False), ('btp_duplicate_message', '=', '')]}">
                    <group>
                        <label for="btp_force_duplicate" string="Force Duplicate"/>
                        <field name="btp_force_duplicate" nolabel="1"/>
                    </group>
                </group>
            </xpath>

            <!-- Add Career History tab -->
            <notebook position="inside">
                <page string="Career History" name="btp_career_history" modifiers="{'invisible': [('is_company', '=', True)]}">
                    <field name="btp_career_history_ids" nolabel="1" context="{'default_contact_id': id}">
                        <list>
                            <field name="company_id"/>
                            <field name="job_title"/>
                            <field name="start_date"/>
                            <field name="end_date"/>
                            <field name="is_current" widget="boolean_toggle"/>
                            <field name="notes"/>
                        </list>
                        <form>
                            <sheet>
                                <group>
                                    <group>
                                        <field name="contact_id" readonly="1"/>
                                        <field name="company_id"/>
                                        <field name="job_title"/>
                                    </group>
                                    <group>
                                        <field name="start_date"/>
                                        <field name="end_date"/>
                                        <field name="is_current" readonly="1"/>
                                    </group>
                                </group>
                                <group>
                                    <field name="notes" placeholder="Additional notes about this career period..."/>
                                </group>
                            </sheet>
                        </form>
                    </field>
                </page>
            </notebook>
            </data>
        </field>
    </record>

    <!-- Extend Company Tree View -->
    <record id="view_partner_tree_btp_company" model="ir.ui.view">
        <field name="name">res.partner.tree.btp.company</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list/field[@name='complete_name']" position="after">
                <field name="siren" column_invisible="[('is_company', '=', False)]"/>
                <field name="siret" column_invisible="[('is_company', '=', False)]"/>
                <field name="btp_assigned_salesperson_id" column_invisible="[('is_company', '=', False)]"/>
                <field name="btp_is_client" widget="boolean_toggle" column_invisible="[('is_company', '=', False)]"/>
                <field name="btp_contact_count" column_invisible="[('is_company', '=', False)]"/>
            </xpath>
        </field>
    </record>

    <!-- Extend Contact Tree View -->
    <record id="view_partner_tree_btp_contact" model="ir.ui.view">
        <field name="name">res.partner.tree.btp.contact</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list/field[@name='complete_name']" position="after">
                <field name="parent_id" string="Company" column_invisible="[('is_company', '=', True)]"/>
                <field name="btp_current_company_id" column_invisible="[('is_company', '=', True)]"/>
                <field name="btp_contact_assigned_salesperson_id" column_invisible="[('is_company', '=', True)]"/>
            </xpath>
        </field>
    </record>

    <!-- Actions for Companies and Contacts -->
    <record id="action_btp_companies" model="ir.actions.act_window">
        <field name="name">BTP Companies</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">list,form,kanban</field>
        <field name="domain">[('is_company', '=', True)]</field>
        <field name="context">{'default_is_company': True, 'search_default_is_company': 1, 'default_btp_duplicate_warning': False, 'default_btp_duplicate_message': ''}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Company
            </p>
            <p>
                Companies are legal entities identified by SIREN/SIRET.
                You can search and enrich company data from external APIs (INSEE/Pappers).
            </p>
        </field>
    </record>

    <record id="action_btp_contacts" model="ir.actions.act_window">
        <field name="name">BTP Contacts</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">list,form,kanban</field>
        <field name="domain">[('is_company', '=', False)]</field>
        <field name="context">{'default_is_company': False, 'search_default_is_company': 0, 'default_btp_duplicate_warning': False, 'default_btp_duplicate_message': ''}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Contact
            </p>
            <p>
                Contacts are physical persons who work for companies.
                The system tracks their career history across different companies.
            </p>
        </field>
    </record>

</odoo>

